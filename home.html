<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Checkout</title>
  <link rel="stylesheet" href="https://necolas.github.io/normalize.css/8.0.0/normalize.css">
  <style>
    html {
      font-family: Arial, Helvetica, sans-serif;
    }

    input[type="text"] {
      border-radius: 6px;
      border: 1px solid #ddd;
      padding: 4px 6px;
    }

    button {
      padding: 6px 10px;
      border: 1px solid #309064;
      border-radius: 6px;
      cursor: pointer;
      background-color: #42b983;
    }
  </style>
</head>
<body>
  <div style="padding: 3rem">
    <h3>Sample Checkout Page</h3>
    <form id="formPay" action="#"  target="_blank">
      <label for="">
        <p>Amount to pay</p>
        <input id="amount" name="amount" type="text" value="300.00" style="width:100px">        
      </label>
      <label for="">
        <p>Currency</p>
          <input id="currency" name="currency" type="text" value="SGD" style="width:200px">
      </label>
      <label for="">
        <p>Payment Reference ID</p>
          <input id="paymentRef" name="payment_ref" type="text" value="ABCD1234" style="width:200px">
      </label>
      <label for="">
        <p>Promotion</p>
          <input id="promotion" name="promo" type="text" value="3.00" style="width:200px">
      </label>
      <label for="">
        <p>Email</p>
          <input id="email" name="email" type="text" value="email@domain.com" style="width:200px">
      </label>
      <br>
      <br>
      <br>
      <input id="mid" type="hidden" name="mid" value="4ba5cc40-8893-4da7-8c07-02cb4acbf7f7">
      <button id="submit" type="submit">
        Pay now
      </button>
    </form>
    <p id="status"></p>
    <span class="Spinner Spinner--path"></span>
    
    <br>
    <p>-------------------</p>
    Merchant ID: 4ba5cc40-8893-4da7-8c07-02cb4acbf7f7
  </div>
  <script>
    // document.getElementById("submit").addEventListener("click", submitForm);
    document.getElementById("formPay").addEventListener("submit", submitForm);
    let statusBox = document.getElementById("status")
    let paymentStatus = 0;
    let merchantId = document.getElementById("mid").value
    let amount = document.getElementById("amount").value
    let currency = document.getElementById("currency").value
    let email = document.getElementById("email").value
    let promotion = document.getElementById("promotion").value
    let payment_ref = document.getElementById("paymentRef").value

    function checkFirst(e) {
      e.preventDefault()
    }
    
    function submitForm(e) {
      e.preventDefault();
      let btn = this;
      btn.disabled = true;
      statusBox.innerText = "Processing payment..."


      let newTab = window.open(`http://pay-redirect.herokuapp.com/pay/verify`);
      // let newTab = window.open(`http://localhost:8080/pay/verify`);
    
      fetch(`https://pay-redirect-api.herokuapp.com/api/v1/payments/token/${merchantId}` ,{
          method: "POST",
          credentials: "same-origin",
          mode: "cors",
          headers: {
            "Content-Type": "application/json; charset=utf-8",
            // "Content-Type": "application/x-www-form-urlencoded",
          },
          body: JSON.stringify( {
            amount: amount,
            currency: currency.toString(),
            email: email.toString(),
            promotion: promotion,
            orderId: payment_ref
          })
        })
        .then( (response) => { return response.json() })
        .then( (data) => {
          statusBox.innerText = "Redirecting to checkout page..."

          // newTab.location.href = `http://localhost:8080/pay/${data.token}`;
          newTab.location.href = `http://pay-redirect.herokuapp.com/pay/${data.token}`;

          console.log(data)
          let x = 0;
        })
        .catch(function(error) {
          status.innerText = error.message;
          console.log('There has been a problem with your fetch operation: ', error.message);
        })
        .finally(() => {
          let interval = setInterval(()=>{
            fetch(`https://pay-redirect-api.herokuapp.com/api/v1/payments/token/${merchantId}/status/${payment_ref}`)
              .then( (response) => { return response.json() })
              .then( (data) => {
                if ( data.status == 'capture') {
                  clearInterval(interval);
                  console.log("Status: ", data.status)
                  statusBox.innerText = "Order paid!" 
                } else if (data.status == 'pending') {
                  console.log("Status: ", data.status)
                  statusBox.innerText = "Waiting for response from the checkout page..."
                } else {
                  clearInterval(interval);
                  console.log("Status: ", data.status)
                  statusBox.innerText = "Something went wrong... Please try again."
                }
              })
          }, 3000);
          // if ( interval == 1 ) {
          //   clearInterval(interval);
          //   statusBox.innerText = "Order paid!"
          // } else {
          // }
        });
    }
    // function checkPaymentStatus() {
    //   let _paymentStatus = 0;

    //   setTimeout(()=>{
    //     statusBox.innerText = "Waiting for response from the checkout page..."
    //   }, 3*1000);

    //   // Check payment status
    //   fetch(`https://pay-redirect-api.herokuapp.com/api/v1/payments/token/${merchantId}/status/${payment_ref}`)
    //     .then( (response) => { return response.json() })
    //     .then( (data) => {
    //       console.log()
    //       return data.isUsed == 0 ? 0 : 1;
    //     })
      
    // }
  </script>
</body>
</html>